/* Page 399 */

/* List 23.1  ?o??t?@?C???L?q?q??L???b?V???O */

/*
     cache.c   -- ?o??p?t?@?C?????L???b?V??????
*/

#include <stdio.h>
#include <string.h>
#include <ctype.h>

int cache_hit = 0;
int cache_missed = 0;


/* ?t?@?C????????? */
#define FILENAME_LEN	64

/* ?L???b?V???????t?@?C?????
   ?i??????I?[?v???????t?@?C????????????????????j */
#define CACHE_SIZE	10

/* ?L???b?V????G???g????\???^ */
typedef struct cache {
    char filename[FILENAME_LEN+1];   /* ?t?@?C???? */
    FILE *fp;			     /* ?t?@?C???L?q?q 
					?iNULL???A????G???g??????g?p
					  ?????j */
    struct cache *prev;		     /* ?O??v?f???w?? */
    struct cache *next;		     /* ????v?f???w?? */
} cache_t;

/* ?L???b?V??????? */
cache_t	 cache[CACHE_SIZE];

/* ?L???b?V?????X?g??w?b?_ */
cache_t	 cache_list;

/* pos????O??x??}?????? */
void insert_cache(cache_t *pos, cache_t *x)
{
    pos->prev->next = x;
    x->prev = pos->prev;
    x->next = pos;
    pos->prev = x;
}

/* x????????B???????v?f?i????x?j???? */
cache_t *remove_cache(cache_t *x)
{
    x->prev->next = x->next;
    x->next->prev = x->prev;
    return x;
}

/* ?????????????s???B
   ?v???O??????J?n????A?K??1?????„‘o?????? */
void init_cache()
{
    int	 i;

  /* ?L???b?V???????X?g??A????????? */
    cache_list.next = cache_list.prev = &cache_list;
    for (i = 0; i < CACHE_SIZE; i++) {
	cache[i].fp = NULL;
	insert_cache(&cache_list, &cache[i]);
    }
}

/* ?I?????????s???B
   ?v???O??????I??????A??„‘o?????? */
void end_cache()
{
    int i;

  /* ?I?[?v??????????t?@?C?????????N???[?Y???? */
    for (i = 0; i < CACHE_SIZE; i++) {
	if (cache[i].fp != NULL)
	    fclose(cache[i].fp);
    }
}

/* ?t?@?C??filename???A?y???h???[?h??I?[?v??????A
   ?t?@?C???L?q?q?????B
   ?t?@?C???????????????A?V?K???????B
   ?t?@?C????I?[?v??????s??????NULL???? */
FILE *open_file(char *filename)
{
    cache_t  *p;
    FILE *fp;

  /* ????????t?@?C?????I?[?v???????????`?F?b?N???? */
    for (p = cache_list.next; p != &cache_list; p = p->next) {
	if (strcmp(filename, p->filename) == 0) {

	  /* ????t?@?C????????I?[?v???????????B
	     ?G???g?????L???b?V?????X?g????????????? */
	    printf("Cache hit [%s]\n", filename);
	    cache_hit++;

	    remove_cache(p);
	    insert_cache(&cache_list, p);
	    return p->fp;
	}
    }

  /* ???X?g?????L???b?V???G???g???????o????A
     ???X?g????????????? */
    p = remove_cache(cache_list.next);
    insert_cache(&cache_list, p);

  /* ????t?@?C?????N???[?Y???? */
    if (p->fp != NULL) {
	printf("Closing [%s]\n", p->filename);
	fclose(p->fp);
	p->fp = NULL;
    }

  /* ?t?@?C?????A?y???h???[?h??I?[?v?????? */
    fp = fopen(filename, "a");
    if (fp == NULL) 
	return NULL;

  /* ?L???b?V????t?@?C???L?q?q??t?@?C???????Z?b?g???? */
    printf("Opening [%s]\n", filename);
    p->fp = fp;
    strcpy(p->filename, filename);

    cache_missed++;
    return fp;
}
